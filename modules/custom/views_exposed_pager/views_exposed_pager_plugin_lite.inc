<?php
/**
 * The plugin to handle full pager.
 *
 * @ingroup views_pager_plugins
 */
class views_exposed_pager_plugin_lite extends views_plugin_pager_full {

  const COOKIE_ROW_DELIMETER = ':';
  const COOKIE_KEY_VALUE_DELIMETER = '/';

  function option_definition() {
    $options = parent::option_definition();
    //expose pager by default
    $options['expose']['contains']['items_per_page'] = array('default' => TRUE, 'bool' => TRUE);
    return $options;
  }

  function options_form(&$form, &$form_state) {
    parent::options_form($form, $form_state); // TODO: Change the autogenerated stub
    if(isset($this->display->display_plugin) && $this->display->display_plugin == 'block') {
      $form['warning'] = array(
        '#weight' => -10,
        '#markup' => '<div class="messages warning">' . t('Exposed pagers in block displays require "Use AJAX" to be set to work correctly.') . '</div>',
      );
    }
  }


  function summary_title() {
    if (!empty($this->options['offset'])) {
      return format_plural($this->options['items_per_page'], 'Lite pager, @count item, skip @skip', 'Lite pager, @count items, skip @skip', array('@count' => $this->options['items_per_page'], '@skip' => $this->options['offset']));
    }
    return format_plural($this->options['items_per_page'], 'Lite pager, @count item', 'Lite pager, @count items', array('@count' => $this->options['items_per_page']));
  }

  function use_count_query() {
    return FALSE;
  }



  function exposed_form_alter(&$form, &$form_state) {
    parent::exposed_form_alter($form, $form_state);
    if(empty($this->options['expose']['items_per_page'])) {
      //pager not exposed
      return;
    }
    if(isset($_COOKIE['views_exposed_pager']) && !isset($form_state['input']['items_per_page'])) {
      $views_saved_pager_limits = $this->decode_cookie($_COOKIE['views_exposed_pager']);
      //if exist stored pager limits in cookie, and value is valid, set pager limit from cookie
      if(isset($views_saved_pager_limits[$this->view->vid])
        && isset($form['items_per_page']['#options'][$views_saved_pager_limits[$this->view->vid]])) {

        $form_state['input']['items_per_page'] = $views_saved_pager_limits[$this->view->vid];
        $form['items_per_page']['#default_value'] = $views_saved_pager_limits[$this->view->vid];
        $form_state['input']['items_per_page_from_cookie'] = TRUE;
        $this->view->items_per_page = $views_saved_pager_limits[$this->view->vid];
      }

    }
    $form['items_per_page']['#type'] = 'hidden'; //hide ipp from exposed form since we show it in the pager

    $form['submit']['#attributes']['class'][] = 'exposed-form-submit-button';

    $form['#attributes']['data-form-class'][] = $this->get_exposed_form_class();//add views unique class

    //if there are no other exposed form inputs, hide the buttons
    $button_keys = array('reset', 'submit');
    $show_buttons = FALSE;
    foreach ($form as $key => $item) {
      if (!in_array($key, $button_keys) && is_array($item)  && array_key_exists('#type', $item) && $item['#type'] != 'hidden') {
        $show_buttons = TRUE;
        break;
      }
    }
    if (!$show_buttons) {
      foreach ($button_keys as $key) {
        $form[$key]['#attributes']['class'][] = 'element-hidden';
      }
    }
    $form['#attached']['js'][] = drupal_get_path('module', 'views_exposed_pager') . '/js/views_exposed_pager.js';
  }



  function query() {
    parent::query();

    $next_page = TRUE;
    if (!empty($this->options['total_pages'])) {
      if (($this->current_page + 1) >= $this->options['total_pages']) {
        $next_page = FALSE;
      }
    }
    if ($next_page) {
      $limit = $this->options['items_per_page'];
      $this->view->query->set_limit($limit + 1);
    }
  }

  function post_execute(&$result) {
    if (count($result) > $this->options['items_per_page']) {
      array_pop($result);
      $this->next_page = TRUE;
      global $pager_page_array, $pager_total, $pager_total_items;
      $pager_total[$this->options['id']] = $pager_page_array[$this->options['id']] + 1;
    }
  }



  function render($input) {
    //$pager = parent::render($input);
    global $pager_page_array, $pager_total, $pager_total_items;


    if (empty($pager_page_array[$this->options['id']]) && (!isset($this->next_page) || $this->next_page != TRUE)) {
      return "";
    }
    else {
      $pager_theme = views_theme_functions('pager_lite', $this->view, $this->display);
      $pager = theme($pager_theme, array('parameters' => $input, 'element' => $this->options['id']));
    }

    if(empty($this->options['expose']['items_per_page'])) {
      //pager not exposed
      return $pager;
    }


    $options = explode(',', $this->options['expose']['items_per_page_options']);
    $sanitized_options = array();

    if (is_array($options)) {
      foreach ($options as $option) {
        $sanitized_options[intval($option)] = intval($option);
      }
    }
    $select = array(
      '#title' => $this->options['expose']['items_per_page_label'],
      '#name' => 'items_per_page',
      '#options' => $sanitized_options,
      '#value' => isset($input['items_per_page']) ? $input['items_per_page'] : $this->options['items_per_page'],
      '#attributes' => array(
        'class' => array('views-exposed-pager'),
        'data-form-class' => $this->get_exposed_form_class(),
      )
    );

    $output = theme(
      'views_exposed_pager',
      array(
        'pager' => $pager,
        'exposed_pager_filter' => theme('select', array('element' => $select)),
      )
    );

    return $output;
  }

  /**
   * Provide css class name for current views, based on views name and current display
   */
  function get_exposed_form_class() {
    return 'exposed-form-' . $this->view->name . '-' . $this->view->current_display;
  }

  function exposed_form_submit(&$form, &$form_state, &$exclude) {
    if(isset($form_state['input']['items_per_page']) && empty($form_state['input']['items_per_page_from_cookie'])) {
      $views_pager_limits =  $this->get_views_pager_limits_from_cookie();
      $views_pager_limits[$this->view->vid] = $form_state['input']['items_per_page'];

      $value = $this->encode_cookie($views_pager_limits);
      setrawcookie('views_exposed_pager', $value, time()+60*60*24*365, self::COOKIE_KEY_VALUE_DELIMETER);
    }
    parent::exposed_form_submit($form, $form_state, $exclude);
  }

  /**
   * Convert array with integer key and values to cookie string
   * @param $array
   * @return string
   */
  function encode_cookie($array) {
    $output = '';
    foreach($array as $key => $value) {
      $output = !empty($output) ? $output . self::COOKIE_ROW_DELIMETER : '';
      $output .= $key .  self::COOKIE_KEY_VALUE_DELIMETER . $value;
    }
    return $output;
  }

  /**
   * Decode cookie string to settings array
   * @param $string
   * @return array
   */
  function decode_cookie($string) {
    $output = array();
    $rows = explode(self::COOKIE_ROW_DELIMETER, $string);
    foreach ($rows as $row) {
      $key_value = explode(self::COOKIE_KEY_VALUE_DELIMETER, $row);
      if(isset($key_value[0]) && is_numeric($key_value[0]) && isset($key_value[1]) && is_numeric($key_value[1])) {
        $output[(int) $key_value[0]] = (int) $key_value[1];
      }
    }
    return $output;
  }

  function get_views_pager_limits_from_cookie() {
    $output = array();
    if(isset($_COOKIE['views_exposed_pager'])) {
      $output = $this->decode_cookie($_COOKIE['views_exposed_pager']);
    }
    return $output;
  }

}